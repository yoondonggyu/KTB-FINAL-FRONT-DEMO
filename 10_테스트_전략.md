# AI Server í…ŒìŠ¤íŠ¸ ì „ëµ

> AI ì„œë²„ì˜ ìœ ë‹› í…ŒìŠ¤íŠ¸, í†µí•© í…ŒìŠ¤íŠ¸, E2E í…ŒìŠ¤íŠ¸ ì „ëµ ê°€ì´ë“œ

---

## ğŸ“š ëª©ì°¨

- [1. í…ŒìŠ¤íŠ¸ ê°œìš”](#1-í…ŒìŠ¤íŠ¸-ê°œìš”)
- [2. í…ŒìŠ¤íŠ¸ ìœ í˜• ë° ë²”ìœ„](#2-í…ŒìŠ¤íŠ¸-ìœ í˜•-ë°-ë²”ìœ„)
- [3. í…ŒìŠ¤íŠ¸ ë””ë ‰í„°ë¦¬ êµ¬ì¡°](#3-í…ŒìŠ¤íŠ¸-ë””ë ‰í„°ë¦¬-êµ¬ì¡°)
- [4. ìœ ë‹› í…ŒìŠ¤íŠ¸](#4-ìœ ë‹›-í…ŒìŠ¤íŠ¸)
- [5. í†µí•© í…ŒìŠ¤íŠ¸](#5-í†µí•©-í…ŒìŠ¤íŠ¸)
- [6. E2E í…ŒìŠ¤íŠ¸](#6-e2e-í…ŒìŠ¤íŠ¸)
- [7. LLM/VLM í…ŒìŠ¤íŠ¸ ì „ëµ](#7-llmvlm-í…ŒìŠ¤íŠ¸-ì „ëµ)
- [8. í…ŒìŠ¤íŠ¸ ë„êµ¬ ë° í™˜ê²½](#8-í…ŒìŠ¤íŠ¸-ë„êµ¬-ë°-í™˜ê²½)
- [9. CI/CD ì—°ë™](#9-cicd-ì—°ë™)
- [10. í…ŒìŠ¤íŠ¸ ë¡œë“œë§µ](#10-í…ŒìŠ¤íŠ¸-ë¡œë“œë§µ)

---

## 1. í…ŒìŠ¤íŠ¸ ê°œìš”

### 1.1. í…ŒìŠ¤íŠ¸ ëª©í‘œ

| ëª©í‘œ | ì„¤ëª… |
|------|------|
| **ê¸°ëŠ¥ ì •í™•ì„±** | APIê°€ ëª…ì„¸ëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€ ê²€ì¦ |
| **ì‘ë‹µ í˜•ì‹** | LLM ì¶œë ¥ì´ ì˜ˆìƒ JSON ìŠ¤í‚¤ë§ˆì™€ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦ |
| **ì„±ëŠ¥ ê¸°ì¤€** | ì‘ë‹µ ì‹œê°„, TTFTê°€ ëª©í‘œì¹˜ ë‚´ì¸ì§€ ê²€ì¦ |
| **ì•ˆì •ì„±** | ì—ëŸ¬ ì²˜ë¦¬, íƒ€ì„ì•„ì›ƒ, ì¬ì‹œë„ ë¡œì§ ê²€ì¦ |
| **íšŒê·€ ë°©ì§€** | ì½”ë“œ ë³€ê²½ ì‹œ ê¸°ì¡´ ê¸°ëŠ¥ì´ ê¹¨ì§€ì§€ ì•ŠëŠ”ì§€ ê²€ì¦ |

### 1.2. í…ŒìŠ¤íŠ¸ ëŒ€ìƒ API (9ê°œ)

| # | API | í…ŒìŠ¤íŠ¸ ìš°ì„ ìˆœìœ„ | ë³µì¡ë„ |
|---|-----|---------------|-------|
| 1 | `/ai/ocr/extract` | ğŸŸ¡ Medium | ë¹„ë™ê¸° + VLM |
| 2 | `/ai/file/embed` | ğŸŸ¢ Low | ë‹¨ìˆœ ì„ë² ë”© |
| 3 | `/ai/analyze` | ğŸ”´ High | ìŠ¤íŠ¸ë¦¬ë° + RAG |
| 4 | `/ai/interview/question` | ğŸ”´ High | DB íˆìŠ¤í† ë¦¬ + RAG |
| 5 | `/ai/interview/save` | ğŸŸ¢ Low | ë‹¨ìˆœ ì €ì¥ |
| 6 | `/ai/interview/report` | ğŸ”´ High | ìŠ¤íŠ¸ë¦¬ë° + ë³µì¡í•œ ë¶„ì„ |
| 7 | `/ai/chat` | ğŸ”´ High | ìŠ¤íŠ¸ë¦¬ë° + RAG + Tool Calling |
| 8 | `/ai/calendar/parse` | ğŸŸ¡ Medium | JSON íŒŒì‹± |
| 9 | `/ai/masking/draft` | ğŸŸ¡ Medium | ë¹„ë™ê¸° + VLM |

---

## 2. í…ŒìŠ¤íŠ¸ ìœ í˜• ë° ë²”ìœ„

### 2.1. í…ŒìŠ¤íŠ¸ í”¼ë¼ë¯¸ë“œ

```
                    â–²
                   /â”‚\
                  / â”‚ \
                 /  â”‚  \      E2E í…ŒìŠ¤íŠ¸ (10%)
                /   â”‚   \     - ì‹¤ì œ LLM API í˜¸ì¶œ
               /    â”‚    \    - ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦
              /â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€\
             /      â”‚      \
            /       â”‚       \    í†µí•© í…ŒìŠ¤íŠ¸ (30%)
           /        â”‚        \   - API ì—”ë“œí¬ì¸íŠ¸ ê²€ì¦
          /         â”‚         \  - ì„œë¹„ìŠ¤ ê°„ ì—°ë™
         /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\
        /           â”‚           \
       /            â”‚            \   ìœ ë‹› í…ŒìŠ¤íŠ¸ (60%)
      /             â”‚             \  - ê°œë³„ í•¨ìˆ˜/í´ë˜ìŠ¤
     /              â”‚              \ - Mock í™œìš©
    /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\
```

### 2.2. í…ŒìŠ¤íŠ¸ ìœ í˜•ë³„ íŠ¹ì§•

| ìœ í˜• | ë²”ìœ„ | LLM í˜¸ì¶œ | ì‹¤í–‰ ì‹œê°„ | ëª©ì  |
|------|------|---------|----------|------|
| **ìœ ë‹›** | í•¨ìˆ˜/í´ë˜ìŠ¤ | âŒ Mock | < 1ì´ˆ | ë¡œì§ ê²€ì¦ |
| **í†µí•©** | API ì—”ë“œí¬ì¸íŠ¸ | âŒ Mock ë˜ëŠ” âœ… ì‹¤ì œ | 1~10ì´ˆ | ì—°ë™ ê²€ì¦ |
| **E2E** | ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤ | âœ… ì‹¤ì œ | 10~60ì´ˆ | ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦ |

---

## 3. í…ŒìŠ¤íŠ¸ ë””ë ‰í„°ë¦¬ êµ¬ì¡°

```
ai_server/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ chains/
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py                 # pytest fixtures (ê³µí†µ)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ unit/                       # ìœ ë‹› í…ŒìŠ¤íŠ¸
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ test_prompt_templates.py
â”‚   â”‚   â”œâ”€â”€ test_output_parsers.py
â”‚   â”‚   â”œâ”€â”€ test_embedding_service.py
â”‚   â”‚   â”œâ”€â”€ test_calendar_parser.py
â”‚   â”‚   â”œâ”€â”€ test_masking_coords.py
â”‚   â”‚   â””â”€â”€ test_interview_logic.py
â”‚   â”‚
â”‚   â”œâ”€â”€ integration/                # í†µí•© í…ŒìŠ¤íŠ¸
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ test_ocr_api.py
â”‚   â”‚   â”œâ”€â”€ test_embed_api.py
â”‚   â”‚   â”œâ”€â”€ test_analyze_api.py
â”‚   â”‚   â”œâ”€â”€ test_interview_api.py
â”‚   â”‚   â”œâ”€â”€ test_chat_api.py
â”‚   â”‚   â”œâ”€â”€ test_calendar_api.py
â”‚   â”‚   â””â”€â”€ test_masking_api.py
â”‚   â”‚
â”‚   â”œâ”€â”€ e2e/                        # E2E í…ŒìŠ¤íŠ¸
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ test_resume_flow.py     # ì´ë ¥ì„œ ì—…ë¡œë“œ â†’ ë¶„ì„ ì „ì²´ íë¦„
â”‚   â”‚   â”œâ”€â”€ test_interview_flow.py  # ë©´ì ‘ ì‹œì‘ â†’ ì§ˆë¬¸ â†’ ë¦¬í¬íŠ¸
â”‚   â”‚   â””â”€â”€ test_chat_scenario.py   # ëŒ€í™” + Tool Calling
â”‚   â”‚
â”‚   â”œâ”€â”€ fixtures/                   # í…ŒìŠ¤íŠ¸ ë°ì´í„°
â”‚   â”‚   â”œâ”€â”€ sample_resume.txt
â”‚   â”‚   â”œâ”€â”€ sample_job_posting.txt
â”‚   â”‚   â”œâ”€â”€ sample_image.png
â”‚   â”‚   â””â”€â”€ expected_responses.json
â”‚   â”‚
â”‚   â””â”€â”€ mocks/                      # Mock í´ë˜ìŠ¤
â”‚       â”œâ”€â”€ mock_llm.py
â”‚       â”œâ”€â”€ mock_vectordb.py
â”‚       â””â”€â”€ mock_external_api.py
â”‚
â”œâ”€â”€ pytest.ini                      # pytest ì„¤ì •
â””â”€â”€ requirements-test.txt           # í…ŒìŠ¤íŠ¸ ì˜ì¡´ì„±
```

---

## 4. ìœ ë‹› í…ŒìŠ¤íŠ¸

### 4.1. í…ŒìŠ¤íŠ¸ ëŒ€ìƒ

| ëŒ€ìƒ | íŒŒì¼ | í…ŒìŠ¤íŠ¸ ë‚´ìš© |
|------|------|------------|
| **í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿** | `test_prompt_templates.py` | ë³€ìˆ˜ ì¹˜í™˜, í¬ë§· ê²€ì¦ |
| **ì¶œë ¥ íŒŒì„œ** | `test_output_parsers.py` | JSON íŒŒì‹±, ìŠ¤í‚¤ë§ˆ ê²€ì¦ |
| **ì„ë² ë”© ì²˜ë¦¬** | `test_embedding_service.py` | ì²­í‚¹, ë²¡í„° ë³€í™˜ ë¡œì§ |
| **ìº˜ë¦°ë” íŒŒì„œ** | `test_calendar_parser.py` | ë‚ ì§œ ì¶”ì¶œ, ì¼ì • êµ¬ì¡°í™” |
| **ë§ˆìŠ¤í‚¹ ì¢Œí‘œ** | `test_masking_coords.py` | ì¢Œí‘œ ë³€í™˜, ì˜ì—­ ê³„ì‚° |
| **ë©´ì ‘ ë¡œì§** | `test_interview_logic.py` | ì§ˆë¬¸ ìˆ˜ ì²´í¬, ì„¸ì…˜ ê´€ë¦¬ |

### 4.2. ì˜ˆì‹œ ì½”ë“œ

#### í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ í…ŒìŠ¤íŠ¸

```python
# tests/unit/test_prompt_templates.py
import pytest
from app.prompts.analyze_prompts import create_analyze_prompt

class TestAnalyzePrompt:
    """ë¶„ì„ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ í…ŒìŠ¤íŠ¸"""
    
    def test_create_analyze_prompt_with_valid_input(self):
        """ì •ìƒ ì…ë ¥ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        resume = "3ë…„ì°¨ ë°±ì—”ë“œ ê°œë°œì, Python, FastAPI ê²½í—˜"
        posting = "ë°±ì—”ë“œ ê°œë°œì ì±„ìš©, Python í•„ìˆ˜"
        
        prompt = create_analyze_prompt(resume, posting)
        
        assert resume in prompt
        assert posting in prompt
        assert "ë¶„ì„" in prompt or "analyze" in prompt.lower()
    
    def test_create_analyze_prompt_with_empty_resume(self):
        """ë¹ˆ ì´ë ¥ì„œëŠ” ì—ëŸ¬ ë°œìƒ"""
        with pytest.raises(ValueError, match="ì´ë ¥ì„œ"):
            create_analyze_prompt("", "ì±„ìš©ê³µê³ ")
    
    def test_prompt_token_limit(self):
        """í”„ë¡¬í”„íŠ¸ê°€ í† í° í•œê³„ë¥¼ ì´ˆê³¼í•˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸"""
        long_resume = "A" * 50000  # ë§¤ìš° ê¸´ ì´ë ¥ì„œ
        posting = "ì±„ìš©ê³µê³ "
        
        prompt = create_analyze_prompt(long_resume, posting)
        
        # í† í° ìˆ˜ ì¶”ì • (ëŒ€ëµ 4ì = 1í† í°)
        estimated_tokens = len(prompt) / 4
        assert estimated_tokens < 30000  # ì»¨í…ìŠ¤íŠ¸ í•œê³„ ë‚´
```

#### ì¶œë ¥ íŒŒì„œ í…ŒìŠ¤íŠ¸

```python
# tests/unit/test_output_parsers.py
import pytest
from app.services.output_parsers import parse_analyze_response

class TestAnalyzeParser:
    """ë¶„ì„ ê²°ê³¼ íŒŒì„œ í…ŒìŠ¤íŠ¸"""
    
    def test_parse_valid_response(self):
        """ì •ìƒ JSON ì‘ë‹µ íŒŒì‹±"""
        llm_output = '''
        {
            "resume_analysis": {
                "strengths": ["Python ê²½í—˜ 3ë…„"],
                "weaknesses": ["í´ë¼ìš°ë“œ ê²½í—˜ ë¶€ì¡±"],
                "suggestions": ["AWS í•™ìŠµ ì¶”ì²œ"]
            },
            "matching": {
                "score": 85,
                "grade": "A"
            }
        }
        '''
        
        result = parse_analyze_response(llm_output)
        
        assert result["matching"]["score"] == 85
        assert result["matching"]["grade"] == "A"
        assert len(result["resume_analysis"]["strengths"]) > 0
    
    def test_parse_malformed_json(self):
        """ì˜ëª»ëœ JSONì€ ì—ëŸ¬ ë˜ëŠ” ê¸°ë³¸ê°’ ë°˜í™˜"""
        malformed = "ì´ê±´ JSONì´ ì•„ë‹™ë‹ˆë‹¤"
        
        with pytest.raises(ValueError):
            parse_analyze_response(malformed)
    
    def test_parse_missing_required_fields(self):
        """í•„ìˆ˜ í•„ë“œ ëˆ„ë½ ì‹œ ì—ëŸ¬"""
        incomplete = '{"resume_analysis": {}}'
        
        with pytest.raises(KeyError):
            parse_analyze_response(incomplete)
```

#### ë©´ì ‘ ë¡œì§ í…ŒìŠ¤íŠ¸

```python
# tests/unit/test_interview_logic.py
import pytest
from app.services.interview_service import InterviewSession

class TestInterviewSession:
    """ë©´ì ‘ ì„¸ì…˜ ë¡œì§ í…ŒìŠ¤íŠ¸"""
    
    def test_session_creation(self):
        """ì„¸ì…˜ ìƒì„±"""
        session = InterviewSession(
            room_id="room_001",
            interview_type="technical"
        )
        
        assert session.session_id is not None
        assert session.question_count == 0
        assert session.status == "in_progress"
    
    def test_max_questions_limit(self):
        """ìµœëŒ€ ì§ˆë¬¸ ìˆ˜(5ê°œ) ë„ë‹¬ ì‹œ ìë™ ì¢…ë£Œ"""
        session = InterviewSession("room_001", "technical")
        
        for i in range(5):
            session.add_qa(f"ì§ˆë¬¸ {i+1}", f"ë‹µë³€ {i+1}")
        
        assert session.question_count == 5
        assert session.should_auto_end() == True
    
    def test_manual_end(self):
        """ìˆ˜ë™ ì¢…ë£Œ"""
        session = InterviewSession("room_001", "personality")
        session.add_qa("ì§ˆë¬¸ 1", "ë‹µë³€ 1")
        
        session.end(ended_by="manual")
        
        assert session.status == "completed"
        assert session.ended_by == "manual"
```

---

## 5. í†µí•© í…ŒìŠ¤íŠ¸

### 5.1. í…ŒìŠ¤íŠ¸ ëŒ€ìƒ

| API | í…ŒìŠ¤íŠ¸ íŒŒì¼ | ê²€ì¦ í•­ëª© |
|-----|------------|----------|
| `/ai/analyze` | `test_analyze_api.py` | ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ, JSON ìŠ¤í‚¤ë§ˆ |
| `/ai/interview/*` | `test_interview_api.py` | ì§ˆë¬¸ ìƒì„±, ì €ì¥, ë¦¬í¬íŠ¸ ì—°ë™ |
| `/ai/chat` | `test_chat_api.py` | RAG ê²€ìƒ‰, Tool Calling |
| `/ai/calendar/parse` | `test_calendar_api.py` | ì¼ì • ì¶”ì¶œ ì •í™•ë„ |

### 5.2. ì˜ˆì‹œ ì½”ë“œ

#### ë¶„ì„ API í†µí•© í…ŒìŠ¤íŠ¸

```python
# tests/integration/test_analyze_api.py
import pytest
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

class TestAnalyzeAPI:
    """ë¶„ì„ API í†µí•© í…ŒìŠ¤íŠ¸"""
    
    @pytest.fixture
    def sample_request(self):
        return {
            "resume_id": "resume_123",
            "posting_id": "posting_456",
            "resume_text": "3ë…„ì°¨ ë°±ì—”ë“œ ê°œë°œì...",
            "posting_text": "ë°±ì—”ë“œ ê°œë°œì ì±„ìš©..."
        }
    
    def test_analyze_returns_streaming_response(self, sample_request):
        """ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ í˜•ì‹ ê²€ì¦"""
        response = client.post(
            "/ai/analyze",
            json=sample_request,
            headers={"Accept": "text/event-stream"}
        )
        
        assert response.status_code == 200
        assert response.headers["content-type"].startswith("text/event-stream")
    
    def test_analyze_response_schema(self, sample_request, mock_llm):
        """ì‘ë‹µ JSON ìŠ¤í‚¤ë§ˆ ê²€ì¦"""
        response = client.post("/ai/analyze", json=sample_request)
        data = response.json()
        
        # í•„ìˆ˜ í•„ë“œ ê²€ì¦
        assert "resume_analysis" in data
        assert "posting_analysis" in data
        assert "matching" in data
        
        # ë§¤ì¹­ ìŠ¤í‚¤ë§ˆ ê²€ì¦
        matching = data["matching"]
        assert 0 <= matching["score"] <= 100
        assert matching["grade"] in ["S", "A", "B", "C", "D"]
    
    def test_analyze_with_missing_resume(self):
        """ì´ë ¥ì„œ ëˆ„ë½ ì‹œ 400 ì—ëŸ¬"""
        response = client.post(
            "/ai/analyze",
            json={"posting_text": "ì±„ìš©ê³µê³ "}
        )
        
        assert response.status_code == 400
```

#### ë©´ì ‘ API í†µí•© í…ŒìŠ¤íŠ¸

```python
# tests/integration/test_interview_api.py
import pytest
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

class TestInterviewAPI:
    """ë©´ì ‘ API í†µí•© í…ŒìŠ¤íŠ¸"""
    
    def test_interview_full_flow(self, mock_llm, mock_db):
        """ë©´ì ‘ ì „ì²´ íë¦„: ì§ˆë¬¸ ìƒì„± â†’ ì €ì¥ â†’ ë¦¬í¬íŠ¸"""
        
        # 1. ì²« ì§ˆë¬¸ ìƒì„±
        question_response = client.post(
            "/ai/interview/question",
            json={
                "room_id": "room_001",
                "session_id": "session_123",
                "interview_type": "technical",
                "resume_text": "ì´ë ¥ì„œ...",
                "posting_text": "ì±„ìš©ê³µê³ ..."
            }
        )
        assert question_response.status_code == 200
        question_data = question_response.json()
        assert "question" in question_data
        assert question_data["question_number"] == 1
        
        # 2. Q&A ì €ì¥
        save_response = client.post(
            "/ai/interview/save",
            json={
                "room_id": "room_001",
                "session_id": "session_123",
                "question_id": question_data["question_id"],
                "question": question_data["question"],
                "answer": "ì‚¬ìš©ì ë‹µë³€...",
                "is_followup": False,
                "question_number": 1
            }
        )
        assert save_response.status_code == 200
        
        # 3. ë¦¬í¬íŠ¸ ìƒì„± (5ê°œ ì§ˆë¬¸ ì™„ë£Œ ê°€ì •)
        report_response = client.post(
            "/ai/interview/report",
            json={
                "room_id": "room_001",
                "session_id": "session_123",
                "interview_type": "technical",
                "ended_by": "manual"
            }
        )
        assert report_response.status_code == 200
        report_data = report_response.json()
        assert "evaluations" in report_data
        assert "report" in report_data
```

#### ì±„íŒ… API Tool Calling í…ŒìŠ¤íŠ¸

```python
# tests/integration/test_chat_api.py
import pytest
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

class TestChatAPI:
    """ì±„íŒ… API í†µí•© í…ŒìŠ¤íŠ¸"""
    
    def test_chat_with_calendar_tool(self, mock_llm_with_tool_call):
        """ìº˜ë¦°ë” Tool Calling ê²€ì¦"""
        response = client.post(
            "/ai/chat",
            json={
                "room_id": "room_001",
                "user_id": "user_456",
                "message": "ì´ë²ˆ ì£¼ ì¼ì • ì•Œë ¤ì¤˜",
                "history": []
            }
        )
        
        data = response.json()
        
        # Tool í˜¸ì¶œ ì‘ë‹µ í˜•ì‹ ê²€ì¦
        assert data["tool_used"] is not None
        assert data["tool_used"]["tool"] == "get_schedule"
        assert "start_date" in data["tool_used"]["params"]
    
    def test_chat_rag_response(self, mock_llm, mock_vectordb):
        """RAG ê¸°ë°˜ ëŒ€í™” ì‘ë‹µ"""
        response = client.post(
            "/ai/chat",
            json={
                "room_id": "room_001",
                "user_id": "user_456",
                "message": "ë‚´ ì´ë ¥ì„œ ê°•ì ì´ ë­ì•¼?",
                "history": []
            }
        )
        
        data = response.json()
        
        assert data["success"] == True
        assert data["response"] is not None
        assert data["tool_used"] is None  # RAGëŠ” tool ì•„ë‹˜
```

---

## 6. E2E í…ŒìŠ¤íŠ¸

### 6.1. í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

| ì‹œë‚˜ë¦¬ì˜¤ | íë¦„ | ê²€ì¦ í•­ëª© |
|---------|------|----------|
| **ì´ë ¥ì„œ ë¶„ì„** | íŒŒì¼ ì—…ë¡œë“œ â†’ OCR â†’ ì„ë² ë”© â†’ ë¶„ì„ | ì „ì²´ íŒŒì´í”„ë¼ì¸ |
| **ëª¨ì˜ ë©´ì ‘** | ì‹œì‘ â†’ ì§ˆë¬¸ 5ê°œ â†’ ì €ì¥ â†’ ë¦¬í¬íŠ¸ | ì„¸ì…˜ ê´€ë¦¬, ì¼ê´€ì„± |
| **ëŒ€í™” + ì¼ì • ì¶”ê°€** | "ë‚´ì¼ ì¹´ì¹´ì˜¤ ë©´ì ‘ ì¶”ê°€í•´ì¤˜" â†’ Tool â†’ ì €ì¥ | Tool Calling ì—°ë™ |

### 6.2. ì˜ˆì‹œ ì½”ë“œ

```python
# tests/e2e/test_resume_flow.py
import pytest
import time
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

class TestResumeAnalysisFlow:
    """ì´ë ¥ì„œ ë¶„ì„ E2E í…ŒìŠ¤íŠ¸ (ì‹¤ì œ LLM í˜¸ì¶œ)"""
    
    @pytest.mark.e2e
    @pytest.mark.slow
    def test_full_resume_analysis_flow(self):
        """ì´ë ¥ì„œ ì—…ë¡œë“œ â†’ OCR â†’ ì„ë² ë”© â†’ ë¶„ì„ ì „ì²´ íë¦„"""
        
        # 1. OCR ìš”ì²­ (ë¹„ë™ê¸°)
        ocr_response = client.post(
            "/ai/ocr/extract",
            json={
                "file_url": "https://s3.../test_resume.pdf",
                "file_type": "pdf"
            }
        )
        assert ocr_response.status_code == 200
        task_id = ocr_response.json()["task_id"]
        
        # 2. OCR ì™„ë£Œ ëŒ€ê¸° (í´ë§)
        for _ in range(30):  # ìµœëŒ€ 30ì´ˆ ëŒ€ê¸°
            status_response = client.get(f"/ai/task/{task_id}")
            status = status_response.json()["status"]
            if status == "completed":
                break
            time.sleep(1)
        
        assert status == "completed"
        extracted_text = status_response.json()["result"]["extracted_text"]
        
        # 3. ì„ë² ë”© ì €ì¥
        embed_response = client.post(
            "/ai/file/embed",
            json={
                "type": "resume",
                "id": "resume_e2e_test",
                "user_id": "user_e2e",
                "text": extracted_text
            }
        )
        assert embed_response.status_code == 200
        
        # 4. ë¶„ì„ ìš”ì²­
        analyze_response = client.post(
            "/ai/analyze",
            json={
                "resume_id": "resume_e2e_test",
                "posting_id": "posting_e2e",
                "resume_text": extracted_text,
                "posting_text": "ë°±ì—”ë“œ ê°œë°œì ì±„ìš©..."
            }
        )
        assert analyze_response.status_code == 200
        
        # 5. ì‘ë‹µ ê²€ì¦
        result = analyze_response.json()
        assert "resume_analysis" in result
        assert "matching" in result
        assert 0 <= result["matching"]["score"] <= 100
```

---

## 7. LLM/VLM í…ŒìŠ¤íŠ¸ ì „ëµ

### 7.1. Mock vs ì‹¤ì œ í˜¸ì¶œ

| ìƒí™© | ì „ëµ | ì´ìœ  |
|------|------|------|
| **ìœ ë‹› í…ŒìŠ¤íŠ¸** | âœ… Mock | ë¹ ë¥¸ ì‹¤í–‰, ê²°ì •ì  ê²°ê³¼ |
| **í†µí•© í…ŒìŠ¤íŠ¸ (CI)** | âœ… Mock | ë¹„ìš© ì ˆê°, ì•ˆì •ì„± |
| **í†µí•© í…ŒìŠ¤íŠ¸ (ë¡œì»¬)** | âš ï¸ ì„ íƒì  ì‹¤ì œ í˜¸ì¶œ | ì‹¤ì œ ë™ì‘ í™•ì¸ í•„ìš” ì‹œ |
| **E2E í…ŒìŠ¤íŠ¸** | âœ… ì‹¤ì œ í˜¸ì¶œ | ì‹¤ì œ ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦ |

### 7.2. LLM Mock êµ¬í˜„

```python
# tests/mocks/mock_llm.py
from unittest.mock import MagicMock, AsyncMock

class MockLLM:
    """LLM API Mock í´ë˜ìŠ¤"""
    
    def __init__(self, response_type: str = "analyze"):
        self.response_type = response_type
        self.call_count = 0
    
    async def generate(self, prompt: str) -> str:
        """Mock LLM ì‘ë‹µ ìƒì„±"""
        self.call_count += 1
        
        if self.response_type == "analyze":
            return '''
            {
                "resume_analysis": {
                    "strengths": ["Python ê²½í—˜ í’ë¶€"],
                    "weaknesses": ["í´ë¼ìš°ë“œ ê²½í—˜ ë¶€ì¡±"],
                    "suggestions": ["AWS í•™ìŠµ ì¶”ì²œ"]
                },
                "matching": {"score": 85, "grade": "A"}
            }
            '''
        elif self.response_type == "interview_question":
            return '''
            {
                "question": "Pythonì˜ GILì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”.",
                "is_followup": false
            }
            '''
        elif self.response_type == "tool_call":
            return '''
            {
                "tool": "get_schedule",
                "params": {"start_date": "2026-01-06", "end_date": "2026-01-12"}
            }
            '''
        
        return '{"message": "Mock response"}'


# conftest.pyì—ì„œ fixtureë¡œ ë“±ë¡
@pytest.fixture
def mock_llm():
    """LLM Mock fixture"""
    from app.services import llm_service
    original = llm_service.llm
    llm_service.llm = MockLLM()
    yield llm_service.llm
    llm_service.llm = original
```

### 7.3. ì‘ë‹µ í’ˆì§ˆ ê²€ì¦ (E2E ì „ìš©)

```python
# tests/e2e/test_response_quality.py
import pytest
from app.services.quality_evaluator import evaluate_response

class TestResponseQuality:
    """LLM ì‘ë‹µ í’ˆì§ˆ ê²€ì¦ (ì‹¤ì œ í˜¸ì¶œ)"""
    
    @pytest.mark.e2e
    def test_analyze_response_quality(self, real_llm):
        """ë¶„ì„ ì‘ë‹µ í’ˆì§ˆ ê²€ì¦"""
        result = real_llm.analyze(
            resume="3ë…„ì°¨ ë°±ì—”ë“œ ê°œë°œì...",
            posting="ë°±ì—”ë“œ ê°œë°œì ì±„ìš©..."
        )
        
        # í’ˆì§ˆ í‰ê°€
        quality = evaluate_response(result)
        
        assert quality["completeness"] >= 0.8  # í•„ìˆ˜ í•„ë“œ 80% ì´ìƒ
        assert quality["relevance"] >= 0.7     # ê´€ë ¨ì„± 70% ì´ìƒ
        assert quality["format_valid"] == True  # JSON í˜•ì‹ ìœ íš¨
    
    @pytest.mark.e2e
    def test_interview_question_quality(self, real_llm):
        """ë©´ì ‘ ì§ˆë¬¸ í’ˆì§ˆ ê²€ì¦"""
        question = real_llm.generate_question(
            interview_type="technical",
            resume="Python ë°±ì—”ë“œ ê°œë°œì..."
        )
        
        # ì§ˆë¬¸ í’ˆì§ˆ ì²´í¬
        assert len(question) >= 10  # ìµœì†Œ ê¸¸ì´
        assert "?" in question      # ì§ˆë¬¸ í˜•íƒœ
        assert "Python" in question or "ë°±ì—”ë“œ" in question  # ë§¥ë½ ê´€ë ¨ì„±
```

---

## 8. í…ŒìŠ¤íŠ¸ ë„êµ¬ ë° í™˜ê²½

### 8.1. í•„ìˆ˜ ë„êµ¬

| ë„êµ¬ | ìš©ë„ | ì„¤ì¹˜ |
|------|------|------|
| **pytest** | í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ | `pip install pytest` |
| **pytest-asyncio** | ë¹„ë™ê¸° í…ŒìŠ¤íŠ¸ | `pip install pytest-asyncio` |
| **pytest-cov** | ì½”ë“œ ì»¤ë²„ë¦¬ì§€ | `pip install pytest-cov` |
| **httpx** | ë¹„ë™ê¸° HTTP í´ë¼ì´ì–¸íŠ¸ | `pip install httpx` |
| **respx** | HTTP Mock | `pip install respx` |
| **faker** | í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± | `pip install faker` |

### 8.2. í…ŒìŠ¤íŠ¸ ì˜ì¡´ì„± íŒŒì¼

```txt
# requirements-test.txt
pytest>=7.0.0
pytest-asyncio>=0.21.0
pytest-cov>=4.0.0
pytest-timeout>=2.1.0
pytest-xdist>=3.0.0  # ë³‘ë ¬ ì‹¤í–‰
httpx>=0.24.0
respx>=0.20.0
faker>=18.0.0
```

### 8.3. pytest ì„¤ì •

```ini
# pytest.ini
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*

asyncio_mode = auto

markers =
    unit: ìœ ë‹› í…ŒìŠ¤íŠ¸
    integration: í†µí•© í…ŒìŠ¤íŠ¸
    e2e: E2E í…ŒìŠ¤íŠ¸ (ì‹¤ì œ LLM í˜¸ì¶œ)
    slow: ëŠë¦° í…ŒìŠ¤íŠ¸

filterwarnings =
    ignore::DeprecationWarning

# íƒ€ì„ì•„ì›ƒ ì„¤ì •
timeout = 60
timeout_method = thread

# ì»¤ë²„ë¦¬ì§€ ì„¤ì •
addopts = --cov=app --cov-report=html --cov-report=term-missing
```

### 8.4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ëª…ë ¹ì–´

```bash
# ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
pytest

# ìœ ë‹› í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
pytest -m unit

# í†µí•© í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
pytest -m integration

# E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ëŠë¦¼, ë¹„ìš© ë°œìƒ)
pytest -m e2e

# íŠ¹ì • íŒŒì¼ í…ŒìŠ¤íŠ¸
pytest tests/integration/test_analyze_api.py

# ë³‘ë ¬ ì‹¤í–‰ (4ê°œ í”„ë¡œì„¸ìŠ¤)
pytest -n 4

# ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ìƒì„±
pytest --cov=app --cov-report=html

# ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë§Œ ì¬ì‹¤í–‰
pytest --lf
```

---

## 9. CI/CD ì—°ë™

### 9.1. GitHub Actions ì›Œí¬í”Œë¡œìš°

```yaml
# .github/workflows/ai-server-test.yml
name: AI Server Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'ai_server/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'ai_server/**'

jobs:
  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          cd ai_server
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: Run unit tests
        run: |
          cd ai_server
          pytest -m unit --cov=app --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./ai_server/coverage.xml

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-test
    
    services:
      chromadb:
        image: chromadb/chroma:latest
        ports:
          - 8000:8000
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          cd ai_server
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: Run integration tests (with mocks)
        env:
          CHROMA_HOST: localhost
          CHROMA_PORT: 8000
          USE_MOCK_LLM: true  # LLM Mock ì‚¬ìš©
        run: |
          cd ai_server
          pytest -m integration

  e2e-test:
    name: E2E Tests (Manual)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # ìˆ˜ë™ íŠ¸ë¦¬ê±°ë§Œ
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          cd ai_server
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: Run E2E tests
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          USE_MOCK_LLM: false  # ì‹¤ì œ LLM ì‚¬ìš©
        run: |
          cd ai_server
          pytest -m e2e --timeout=120
```

### 9.2. í…ŒìŠ¤íŠ¸ ë‹¨ê³„ë³„ ì‹¤í–‰ ì •ì±…

| ë‹¨ê³„ | íŠ¸ë¦¬ê±° | LLM í˜¸ì¶œ | ì˜ˆìƒ ì‹œê°„ |
|------|-------|---------|----------|
| **ìœ ë‹› í…ŒìŠ¤íŠ¸** | ëª¨ë“  PR/Push | âŒ Mock | ~1ë¶„ |
| **í†µí•© í…ŒìŠ¤íŠ¸** | ëª¨ë“  PR/Push | âŒ Mock | ~3ë¶„ |
| **E2E í…ŒìŠ¤íŠ¸** | ìˆ˜ë™ / ì£¼ê°„ ìŠ¤ì¼€ì¤„ | âœ… ì‹¤ì œ | ~10ë¶„ |

---

## 10. í…ŒìŠ¤íŠ¸ ë¡œë“œë§µ

### 10.1. ë‹¨ê³„ë³„ êµ¬í˜„ ê³„íš

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           í…ŒìŠ¤íŠ¸ ë¡œë“œë§µ                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   Phase 1: MVP (2ì£¼)                                                        â”‚
â”‚   â”œâ”€â”€ pytest í™˜ê²½ êµ¬ì¶•                                                       â”‚
â”‚   â”œâ”€â”€ í•µì‹¬ API ìœ ë‹› í…ŒìŠ¤íŠ¸ (analyze, interview, chat)                         â”‚
â”‚   â”œâ”€â”€ LLM Mock êµ¬í˜„                                                         â”‚
â”‚   â””â”€â”€ ê¸°ë³¸ CI ì—°ë™ (GitHub Actions)                                          â”‚
â”‚                                                                             â”‚
â”‚   Phase 2: 1ì°¨ ë°°í¬ (3ì£¼)                                                   â”‚
â”‚   â”œâ”€â”€ ì „ì²´ API ìœ ë‹› í…ŒìŠ¤íŠ¸ ì™„ë£Œ                                               â”‚
â”‚   â”œâ”€â”€ í†µí•© í…ŒìŠ¤íŠ¸ êµ¬í˜„ (API ì—”ë“œí¬ì¸íŠ¸)                                        â”‚
â”‚   â”œâ”€â”€ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ 60% ë‹¬ì„±                                                â”‚
â”‚   â””â”€â”€ VectorDB Mock êµ¬í˜„                                                    â”‚
â”‚                                                                             â”‚
â”‚   Phase 3: 2ì°¨ ë°°í¬ (4ì£¼)                                                   â”‚
â”‚   â”œâ”€â”€ E2E í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ êµ¬í˜„                                                â”‚
â”‚   â”œâ”€â”€ ì‘ë‹µ í’ˆì§ˆ ê²€ì¦ í…ŒìŠ¤íŠ¸                                                   â”‚
â”‚   â”œâ”€â”€ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (ë¶€í•˜ í…ŒìŠ¤íŠ¸)                                               â”‚
â”‚   â””â”€â”€ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ 80% ë‹¬ì„±                                                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2. ì»¤ë²„ë¦¬ì§€ ëª©í‘œ

| ë‹¨ê³„ | ëª©í‘œ ì»¤ë²„ë¦¬ì§€ | ì¸¡ì • ë²”ìœ„ |
|------|-------------|----------|
| **MVP** | 40% | í•µì‹¬ ì„œë¹„ìŠ¤ ë¡œì§ |
| **1ì°¨ ë°°í¬** | 60% | API ë ˆì´ì–´ í¬í•¨ |
| **2ì°¨ ë°°í¬** | 80% | ì „ì²´ ì½”ë“œë² ì´ìŠ¤ |

### 10.3. í…ŒìŠ¤íŠ¸ ìš°ì„ ìˆœìœ„

| ìš°ì„ ìˆœìœ„ | API | ì´ìœ  |
|---------|-----|------|
| â­â­â­ | `/ai/analyze` | í•µì‹¬ ê¸°ëŠ¥, ë³µì¡ë„ ë†’ìŒ |
| â­â­â­ | `/ai/interview/*` | ì„¸ì…˜ ê´€ë¦¬, ìƒíƒœ ìœ ì§€ |
| â­â­â­ | `/ai/chat` | Tool Calling, RAG ë³µí•© |
| â­â­ | `/ai/calendar/parse` | JSON íŒŒì‹± ì •í™•ë„ |
| â­â­ | `/ai/masking/draft` | ì¢Œí‘œ ì¶”ì¶œ ì •í™•ë„ |
| â­ | `/ai/ocr/extract` | VLM ì˜ì¡´, Mock ì–´ë ¤ì›€ |
| â­ | `/ai/file/embed` | ë‹¨ìˆœ ë¡œì§ |

---

## ì°¸ê³  ìë£Œ

- [pytest ê³µì‹ ë¬¸ì„œ](https://docs.pytest.org/)
- [FastAPI Testing](https://fastapi.tiangolo.com/tutorial/testing/)
- [LangChain Testing](https://python.langchain.com/docs/guides/debugging)
- [API ëª…ì„¸ì„œ](API_ëª…ì„¸.md)
- [ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ ëª¨ë“ˆí™”](ì•„í‚¤í…ì²˜_ì„¤ê³„.md)
